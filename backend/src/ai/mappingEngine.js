// backend/src/ai/mappingEngine.js

exports.process = async (rawText) => {
    console.log("üß† [AI Mapping] Analyzing text...");

    const result = {
        vendor: "Unknown",
        date: null,
        total: 0,
        items: []
    };

    try {
        if (!rawText) return result;

        // ‡πÅ‡∏¢‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢
        const lines = rawText.split('\n').map(l => l.trim()).filter(l => l.length > 0);

        // ===============================================
        // 1. ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (Vendor)
        // ===============================================
        // ‡∏õ‡∏Å‡∏ï‡∏¥‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å‡πÜ ‡πÉ‡∏´‡πâ‡∏ß‡∏ô‡∏´‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó", "‡∏´‡∏à‡∏Å", "Store", "Shop"
        for (let i = 0; i < Math.min(5, lines.length); i++) {
            const line = lines[i];
            // ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ç‡∏¢‡∏∞ (Special Characters) ‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å OCR ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
            const cleanLine = line.replace(/[^\u0E00-\u0E7Fa-zA-Z0-9\s\.\-]/g, '').trim();
            
            if (cleanLine.length > 3) {
                result.vendor = cleanLine;
                break; // ‡πÄ‡∏à‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏•‡∏¢
            }
        }

        // ===============================================
        // 2. ‡∏´‡∏≤‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° (Smart Total Extraction)
        // ===============================================
        // ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ: ‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà "‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î"
        // (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥‡∏¢‡∏≠‡∏î Total ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏¢‡∏≠‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏ö‡∏¥‡∏•)
        
        // Regex: ‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° (‡πÄ‡∏ä‡πà‡∏ô 1,200.50 ‡∏´‡∏£‡∏∑‡∏≠ 500.00)
        const pricePattern = /[\d,]+\.\d{2}\b/g;
        const foundNumbers = rawText.match(pricePattern);

        if (foundNumbers) {
            // ‡πÅ‡∏õ‡∏•‡∏á string "1,200.50" -> float 1200.50 ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢
            const amounts = foundNumbers
                .map(num => parseFloat(num.replace(/,/g, '')))
                .filter(num => !isNaN(num));

            if (amounts.length > 0) {
                // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÄ‡∏õ‡πá‡∏ô Total
                result.total = Math.max(...amounts);
            }
        }

        // ===============================================
        // 3. (Optional) ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤ "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"
        // ===============================================
        // ‡∏´‡∏≤ Pattern ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏ä‡πà‡∏ô 01/11/68 ‡∏´‡∏£‡∏∑‡∏≠ 2024-01-01
        const dateMatch = rawText.match(/(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})/);
        if (dateMatch) {
            result.date = dateMatch[0]; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠
        }

        // 4. Mock Item (‡πÑ‡∏ß‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LLM ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á)
        result.items.push({
            name: "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô OCR (‡∏£‡∏≠ AI ‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á)",
            price: result.total,
            qty: 1
        });

    } catch (error) {
        console.error("‚ùå Mapping Error:", error);
    }

    return result;
};